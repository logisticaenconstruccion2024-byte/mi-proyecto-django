<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de {{ producto.nombre }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para el efecto de zoom */
        .zoom-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            border-radius: 1.5rem; /* rounded-2xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-xl */
            border: 1px solid rgb(229 231 235); /* border-gray-200 */
        }

        .zoom-image {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: zoom-in;
            transition: transform 0.3s ease-in-out;
            touch-action: none; /* Previene el zoom del navegador en móviles */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Encabezado actualizado para incluir categorías y el carrito de compras -->
    <header class="bg-pink-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <!-- Logo y nombre de la marca -->
            <a href="{% url 'catalogo_publico' %}" class="text-3xl font-bold mb-4 md:mb-0 transition-colors hover:text-pink-100">Lencería Fina</a>
            
            <!-- Menú de categorías - Adaptado para ser más responsivo -->
            <nav class="flex flex-wrap justify-center md:justify-start space-x-2 md:space-x-4 mb-4 md:mb-0">
                <a href="#" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">Todos</a>
                <a href="#" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">Mallas enterizas</a>
                <a href="#" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">Lencería</a>
                <a href="#" class="bg-pink-700 hover:bg-pink-800 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">Disfraz sexy</a>
            </nav>

            <!-- Sección de búsqueda y acciones de usuario -->
            <div class="flex items-center space-x-4">
                <a href="{% url 'login' %}" class="hidden sm:block bg-pink-700 hover:bg-pink-800 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300">Iniciar Sesión</a>

                <!-- Enlace al carrito de compras con contador -->
                <a href="{% url 'ver_carrito' %}" class="relative">
                    <i class="fas fa-shopping-cart text-3xl hover:text-pink-200 transition-colors duration-300"></i>
                    <span id="cart-counter" class="absolute -top-1 -right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-pink-600 animate-pulse">
                        0 <!-- Este valor se actualizará con JavaScript -->
                    </span>
                </a>
                
                <!-- Barra de búsqueda -->
                <div class="hidden lg:block"> <!-- Se oculta en pantallas pequeñas -->
                    <div class="relative">
                        <input type="text" placeholder="Buscar productos..." class="py-2 pl-4 pr-10 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-pink-500 shadow-inner">
                        <i class="fas fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-16">
            <!-- Columna de la imagen del producto -->
            <div>
                {% if producto.imagen_principal %}
                    <!-- Contenedor del zoom con una imagen de fondo -->
                    <div id="zoom-container-{{ producto.id }}" class="zoom-container mb-4 relative">
                        <div id="zoom-image-{{ producto.id }}"
                             class="zoom-image"
                             style="background-image: url('{{ producto.imagen_principal.url }}');"
                             role="img"
                             aria-label="Imagen de {{ producto.nombre }}">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap justify-center space-x-2 mt-4">
                        {% for variante in producto.variantes.all %}
                            <!-- Añadimos la clase `color-selector` y un ícono de corona -->
                            <div 
                                onclick="changeProductImageAndStock(event, '{{ producto.id }}', '{{ variante.imagen.url }}', '{{ variante.stock }}', '{{ variante.pk }}')"
                                class="color-selector relative w-12 h-12 rounded-full border-2 border-red-500 cursor-pointer transition-transform duration-200 hover:scale-110 flex items-center justify-center {% if forloop.first %}selected{% endif %}"
                                style="background-color: {{ variante.color | lower }};"
                                title="{{ variante.color }}">
                                <!-- Ícono de corona, visible solo en el elemento seleccionado -->
                                <i class="fas fa-crown text-white text-xl {% if not forloop.first %}hidden{% endif %}"></i>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Fallback if no main image exists -->
                    <div class="w-full aspect-square mb-4 overflow-hidden rounded-2xl shadow-xl border border-gray-200 flex items-center justify-center bg-gray-200 text-gray-500 font-bold">
                        Imagen no disponible
                    </div>
                {% endif %}
            </div>
            
            <!-- Columna de los detalles del producto -->
            <div class="flex flex-col justify-center">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2 leading-tight">{{ producto.nombre }}</h1>
                <p class="text-3xl font-bold text-pink-600 mb-6">S/{{ producto.precio }}</p>
                <p class="text-gray-600 text-lg mb-6 leading-relaxed">{{ producto.descripcion }}</p>
                
                <div class="mb-6">
                    <p class="text-sm text-gray-500">
                        Stock disponible: 
                        <span id="stock-{{ producto.id }}" class="font-bold text-gray-800">
                            {% if producto.variantes.first %}{{ producto.variantes.first.stock }}{% else %}0{% endif %}
                        </span> 
                        unidades
                    </p>
                </div>
                
                <form id="form-add-to-cart-{{ producto.id }}" method="post" action="{% url 'add_to_cart' %}" onsubmit="handleAddToCart(event, {{ producto.id }})">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ producto.pk }}">
                    <input type="hidden" name="variant_id" id="color_variante-{{ producto.id }}" value="{% if producto.variantes.first %}{{ producto.variantes.first.pk }}{% endif %}">
                    
                    <!-- Campo de cantidad -->
                    <div class="flex items-center mb-6">
                        <span class="mr-6 font-bold text-gray-700">Cantidad:</span>
                        <div class="flex items-center space-x-2 border rounded-full overflow-hidden shadow-sm">
                            <button type="button" onclick="changeQuantity({{ producto.id }}, -1)" class="bg-gray-200 text-gray-700 w-10 h-10 flex items-center justify-center hover:bg-gray-300 transition-colors duration-200">-</button>
                            <input 
                                type="number" 
                                name="quantity" 
                                id="quantity-{{ producto.id }}" 
                                value="1" 
                                min="1" 
                                class="w-16 text-center bg-white text-gray-800 focus:outline-none"
                                onchange="validateQuantity({{ producto.id }})"
                            >
                            <button type="button" onclick="changeQuantity({{ producto.id }}, 1)" class="bg-gray-200 text-gray-700 w-10 h-10 flex items-center justify-center hover:bg-gray-300 transition-colors duration-200">+</button>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-rose-500 text-white font-bold text-xl py-4 px-6 rounded-full shadow-lg hover:bg-rose-600 transition-transform duration-200 hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Añadir al Carrito
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Modal de confirmación de carrito -->
    <div id="add-to-cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 hidden">
        <div class="relative w-full max-w-sm mx-auto p-8 rounded-3xl shadow-2xl bg-white text-center transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">¡Producto Añadido!</h3>
            <p class="text-sm text-gray-600 mb-6">El producto ha sido añadido al carrito con éxito.</p>
            <div class="flex flex-col space-y-4">
                <a href="{% url 'ver_carrito' %}" class="px-6 py-3 bg-pink-500 text-white font-bold rounded-full hover:bg-pink-600 transition-colors duration-300">
                    Ir al Carrito
                </a>
                <a href="{% url 'catalogo_publico' %}" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-full hover:bg-gray-300 transition-colors duration-300">
                    Seguir Comprando
                </a>
                <button onclick="closeModal('add-to-cart-modal')" class="px-6 py-3 text-gray-600 font-bold rounded-full hover:bg-gray-100 transition-colors duration-300">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de error genérico -->
    <div id="error-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300 hidden">
        <div class="relative w-full max-w-sm mx-auto p-8 rounded-3xl shadow-2xl bg-white text-center transform transition-transform duration-300 scale-95">
            <h3 class="text-2xl font-bold text-red-600 mb-4">¡Error!</h3>
            <p id="error-message" class="text-sm text-gray-600 mb-6">Hubo un error.</p>
            <button onclick="closeModal('error-modal')" class="w-full px-6 py-3 bg-red-500 text-white font-bold rounded-full hover:bg-red-600 transition-colors duration-300">
                Entendido
            </button>
        </div>
    </div>

       <!-- Botones de redes sociales flotantes -->
    <div class="fixed bottom-6 left-6 flex flex-col space-y-2 z-50">
        <a href="https://wa.me/51932187068" class="bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-colors" target="_blank">
            <i class="fab fa-whatsapp text-2xl"></i>
        </a>
        <a href="https://web.facebook.com/fantasiaintimaa/" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors" target="_blank">
            <i class="fab fa-facebook-f text-2xl"></i>
        </a>
        <a href="https://www.instagram.com/fantasia_intima_lenceria" class="bg-pink-600 text-white p-4 rounded-full shadow-lg hover:bg-pink-700 transition-colors" target="_blank">
            <i class="fab fa-instagram text-2xl"></i>
        </a>
        <a href="https://www.tiktok.com/@fantasa.ntima" class="bg-black text-white p-4 rounded-full shadow-lg hover:bg-gray-800 transition-colors" target="_blank">
            <i class="fab fa-tiktok text-2xl"></i>
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialVariantId = document.getElementById('color_variante-{{ producto.id }}').value;
            const initialStock = parseInt(document.getElementById('stock-{{ producto.id }}').textContent);
            
            const quantityInput = document.getElementById('quantity-' + productId);
            if (quantityInput && initialStock > 0) {
                quantityInput.max = initialStock;
            } else if (quantityInput) {
                quantityInput.max = 0;
                quantityInput.value = 0;
            }

            // Configura el efecto de zoom para la imagen inicial
            setupImageZoom('{{ producto.id }}');
        });

        // Función para cambiar la imagen y el stock, ahora con la lógica de la corona
        function changeProductImageAndStock(event, productId, imageUrl, stock, variantId) {
            const zoomImage = document.getElementById('zoom-image-' + productId);
            const stockElement = document.getElementById('stock-' + productId);
            const variantInput = document.getElementById('color_variante-' + productId);
            const quantityInput = document.getElementById('quantity-' + productId);
            const addToCartButton = document.querySelector(`#form-add-to-cart-${productId} button[type="submit"]`);

            // 1. Lógica para la corona: Oculta todas las coronas y muestra la del elemento seleccionado
            document.querySelectorAll('.color-selector').forEach(el => {
                const crown = el.querySelector('.fa-crown');
                if (crown) {
                    crown.classList.add('hidden');
                }
            });

            // Muestra la corona del elemento actual
            const selectedElement = event.currentTarget;
            const selectedCrown = selectedElement.querySelector('.fa-crown');
            if (selectedCrown) {
                selectedCrown.classList.remove('hidden');
            }
            
            // 2. Lógica existente para actualizar la imagen, stock, etc.
            zoomImage.style.backgroundImage = `url('${imageUrl}')`;
            stockElement.textContent = stock;
            variantInput.value = variantId;

            quantityInput.value = 1;
            quantityInput.max = stock;
            
            if (parseInt(stock) <= 0) {
                addToCartButton.disabled = true;
            } else {
                addToCartButton.disabled = false;
            }
        }
        
        // Función para configurar el efecto de zoom
        function setupImageZoom(productId) {
            const zoomContainer = document.getElementById('zoom-container-' + productId);
            const zoomImage = document.getElementById('zoom-image-' + productId);
            
            if (!zoomContainer || !zoomImage) return;

            // Maneja el efecto de "magnifying glass" en dispositivos de escritorio
            const handleMouseMove = (e) => {
                const { left, top, width, height } = zoomContainer.getBoundingClientRect();
                const x = (e.clientX - left) / width * 100;
                const y = (e.clientY - top) / height * 100;
                zoomImage.style.backgroundPosition = `${x}% ${y}%`;
            };

            const handleMouseEnter = () => {
                zoomImage.style.backgroundSize = '200%'; /* Nivel de zoom, puedes ajustarlo */
                zoomImage.style.cursor = 'zoom-out';
            };

            const handleMouseLeave = () => {
                zoomImage.style.backgroundSize = 'contain';
                zoomImage.style.backgroundPosition = 'center';
                zoomImage.style.cursor = 'zoom-in';
            };

            // Aplica los listeners para desktop
            zoomContainer.addEventListener('mousemove', handleMouseMove);
            zoomContainer.addEventListener('mouseenter', handleMouseEnter);
            zoomContainer.addEventListener('mouseleave', handleMouseLeave);
            
            // Lógica para dispositivos táctiles (simula el zoom con un solo toque)
            const handleTouchStart = (e) => {
                // Previene el comportamiento predeterminado del navegador, como el zoom de la página
                e.preventDefault(); 
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    const { left, top, width, height } = zoomContainer.getBoundingClientRect();
                    const x = (touch.clientX - left) / width * 100;
                    const y = (touch.clientY - top) / height * 100;
                    zoomImage.style.backgroundPosition = `${x}% ${y}%`;
                    zoomImage.style.backgroundSize = '200%';
                }
            };
            
            const handleTouchEnd = () => {
                zoomImage.style.backgroundSize = 'contain';
                zoomImage.style.backgroundPosition = 'center';
            };

            // Aplica los listeners para dispositivos táctiles
            zoomContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
            zoomContainer.addEventListener('touchend', handleTouchEnd);
        }

        async function handleAddToCart(event, productId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const quantityInput = document.getElementById('quantity-' + productId);
            if (parseInt(quantityInput.value) > parseInt(quantityInput.max) || parseInt(quantityInput.value) <= 0) {
                showErrorModal('La cantidad seleccionada no es válida.');
                return;
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    updateCartCount(data.cart_count);
                    const modal = document.getElementById('add-to-cart-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                    }
                } else {
                    const errorData = await response.json();
                    showErrorModal(errorData.error || 'Hubo un error al añadir el producto al carrito.');
                }
            } catch (error) {
                showErrorModal('Ocurrió un problema de conexión. Por favor, inténtalo de nuevo.');
            }
        }
        
        function changeQuantity(productId, change) {
            const quantityInput = document.getElementById('quantity-' + productId);
            let currentValue = parseInt(quantityInput.value);
            let newValue = currentValue + change;
            const maxStock = parseInt(quantityInput.max);

            if (newValue < 1) {
                newValue = 1;
            }
            if (newValue > maxStock) {
                newValue = maxStock;
            }

            quantityInput.value = newValue;
        }

        function validateQuantity(productId) {
            const quantityInput = document.getElementById('quantity-' + productId);
            let value = parseInt(quantityInput.value);
            const maxStock = parseInt(quantityInput.max);

            if (isNaN(value) || value < 1) {
                quantityInput.value = 1;
            } else if (value > maxStock) {
                quantityInput.value = maxStock;
            }
        }
        
        function updateCartCount(count) {
            const cartCountElement = document.getElementById('cart-counter');
            if (cartCountElement) {
                cartCountElement.textContent = count;
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showErrorModal(message) {
            const modal = document.getElementById('error-modal');
            const errorMessageElement = document.getElementById('error-message');
            if (errorMessageElement) {
                errorMessageElement.textContent = message;
            }
            if (modal) {
                modal.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
